name: Build Component Containers

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/openadkit

jobs:
  # =============================================================================
  # Stage 1: Build base images
  # =============================================================================
  build-base:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        target: [autoware-base, autoware-base-cuda]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Checkout Autoware
        uses: actions/checkout@v6
        with:
          repository: autowarefoundation/autoware
          ref: main
          path: autoware
          fetch-depth: 1
          
      - name: Install jq and vcs2l
        run: |
            sudo apt-get -y update
            sudo apt-get -y install jq python3-pip
            pip install --no-cache-dir vcs2l
        shell: bash
    
      - name: Pull Autoware Source
        run: |
            mkdir -p autoware/src
            vcs import --shallow autoware/src < autoware/repositories/autoware.repos
        shell: bash

    #   - name: Free disk space
    #     uses: ./.github/actions/free-disk-space

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for ${{ matrix.target }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.target }}
          bake-target: docker-metadata-action-${{ matrix.target }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.target }}
        uses: docker/bake-action@v5
        with:
          files: |
            components/docker-bake-base.hcl
            ${{ steps.meta.outputs.bake-file }}
          targets: ${{ matrix.target }}
          push: true

  # =============================================================================
  # Stage 2: Build intermediate images
  # =============================================================================
  build-intermediate:
    runs-on: ubuntu-latest
    needs: build-base
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - target: rosdep-depend
            bake-file: components/docker-bake.hcl
          - target: core-devel
            bake-file: components/docker-bake.hcl
          - target: autoware-common-devel
            bake-file: components/docker-bake.hcl
          - target: autoware-common-devel-cuda
            bake-file: components/docker-bake-cuda.hcl
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for ${{ matrix.target }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.target }}
          bake-target: docker-metadata-action-${{ matrix.target }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.target }}
        uses: docker/bake-action@v5
        with:
          files: |
            ${{ matrix.bake-file }}
            ${{ steps.meta.outputs.bake-file }}
          targets: ${{ matrix.target }}
          push: true
          set: |
            *.args.AUTOWARE_BASE_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-base:latest
            *.args.AUTOWARE_BASE_CUDA_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-base-cuda:latest

  # =============================================================================
  # Stage 3: Build component images (parallel)
  # =============================================================================
  build-components:
    runs-on: ubuntu-latest
    needs: build-intermediate
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: autoware-sensing-perception
            bake-file: components/docker-bake.hcl
          - target: autoware-sensing-perception-cuda
            bake-file: components/docker-bake-cuda.hcl
          - target: autoware-localization-mapping
            bake-file: components/docker-bake.hcl
          - target: autoware-planning-control
            bake-file: components/docker-bake.hcl
          - target: autoware-vehicle-system
            bake-file: components/docker-bake.hcl
          - target: autoware-visualization
            bake-file: components/docker-bake.hcl
          - target: autoware-api
            bake-file: components/docker-bake.hcl
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for ${{ matrix.target }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.target }}
          bake-target: docker-metadata-action-${{ matrix.target }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.target }}
        uses: docker/bake-action@v5
        with:
          files: |
            ${{ matrix.bake-file }}
            ${{ steps.meta.outputs.bake-file }}
          targets: ${{ matrix.target }}
          push: true
          set: |
            *.args.AUTOWARE_BASE_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-base:latest
            *.args.AUTOWARE_BASE_CUDA_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-base-cuda:latest
            *.args.ROSDEP_IMAGE=${{ env.IMAGE_PREFIX }}/rosdep-depend:latest
            *.args.UNIVERSE_COMMON_DEVEL_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-common-devel:latest
            *.args.UNIVERSE_COMMON_DEVEL_CUDA_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-common-devel-cuda:latest
            *.args.AUTOWARE_COMMON_DEVEL_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-common-devel:latest

  # =============================================================================
  # Stage 4: Build final monolithic images
  # =============================================================================
  build-universe:
    runs-on: ubuntu-latest
    needs: build-components
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - target: autoware-universe
            bake-file: components/docker-bake.hcl
          - target: autoware-cuda
            bake-file: components/docker-bake-cuda.hcl
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for ${{ matrix.target }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_PREFIX }}/${{ matrix.target }}
          bake-target: docker-metadata-action-${{ matrix.target }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.target }}
        uses: docker/bake-action@v5
        with:
          files: |
            ${{ matrix.bake-file }}
            ${{ steps.meta.outputs.bake-file }}
          targets: ${{ matrix.target }}
          push: true
          set: |
            *.args.AUTOWARE_BASE_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-base:latest
            *.args.AUTOWARE_BASE_CUDA_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-base-cuda:latest
            *.args.ROSDEP_IMAGE=${{ env.IMAGE_PREFIX }}/rosdep-depend:latest
            *.args.AUTOWARE_COMMON_DEVEL_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-common-devel:latest
            *.args.AUTOWARE_COMMON_DEVEL_CUDA_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-common-devel-cuda:latest
            *.args.AUTOWARE_SENSING_PERCEPTION_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-sensing-perception:latest
            *.args.AUTOWARE_SENSING_PERCEPTION_CUDA_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-sensing-perception-cuda:latest
            *.args.AUTOWARE_LOCALIZATION_MAPPING_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-localization-mapping:latest
            *.args.AUTOWARE_PLANNING_CONTROL_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-planning-control:latest
            *.args.AUTOWARE_VEHICLE_SYSTEM_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-vehicle-system:latest
            *.args.AUTOWARE_VISUALIZATION_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-visualization:latest
            *.args.AUTOWARE_API_IMAGE=${{ env.IMAGE_PREFIX }}/autoware-api:latest
